\chapter{Resultados}
En este capítulo se presentan algunos de los resultados obtenidos para las distintas implementaciones, tanto de tiempo de cómputo como de calidad numérica en los resultados.


Los sistemas utilizados para las evaluaciones se detallan en el apéndice \ref{sistemas}. 
Por otro lado, en la primera sección de este capítulo se describen algunas consideraciones generales acerca de los sistemas y parámetros de ejecución que se deben tener en cuenta para hacer una correcta interpretación de los resultados.
% dad varios aspectos de los sistemas de prueba son relevantes para hacer una correcto análisis de los resultados,

Para todas las mediciones de tiempos de ejecuci\'on se utilizó el reloj est\'andar de alta precisi\'on para Linux (\texttt{clock\_gettime}~\cite{LinuxDocumentation}). 
% El equipamiento utilizado para las pruebas se detallan en el apéndice \ref{equipamiento}. 
Los detalles del hardware utilizado se encuentran en el apéndice \ref{equipamiento}. 
Las pruebas correspondientes a los tiempos de ejecución se realizan midiendo exclusivamente el tiempo de la etapa de cálculo de fuerzas, sobre la cual se plantearon las modificaciones.

% PONER ALGO MAS DE QUE ASPECTOS SON RELEVANTES
% En el apéndice \ref{sistemas} se detalla la forma en que los sistemas de partículas fueron construidos y las propiedades de estos.

% 
% Claramente, el factor mas importante del sistema que afectará a la ejecución es el número total de partículas de éste. Los tamaños de sistemas utilizados fueron tres, y para 
% 
% Además del tamaño, hay otros factores del sistema que se tuvieron en cuenta para realizar una correcta evaluación y que deben ser 
% Para tener en cuenta cualquier posible diferencia relacionada a los tipos de partículas, la asignación de tipos se hizo de forma aleatoria entre un total de 37 tipos existentes.
% 
% Además de las posiciones y tipos de particulas, es posible especificar velocidades iniciales....

% En cuanto a los parámetros de ejecución, se debe tener en cuenta que a medida que la simulación avanza, las partículas son libres de difundir y éste es el resultado natural de una simulación en el vacío.
\section{Consideraciones previas}
Para poder evaluar correctamente el tiempo de ejecución asociado a una simulación, se debe tener en cuenta como afectan los parámetros utilizados.

Como se explicó en los capítulos previos, la combinación de \textit{cutoff} y tamaño/configuración del sístema define el número total de interacciones que se deben calcular y, por lo tanto, 
el número de cálculos a realizar en una iteración. El valor de \textit{cutoff} es constante durante toda la ejecución, sin embargo, la configuración del sistema (posiciones relativas de las partículas) obviamente no lo es.

Es importante tener en cuenta que, si no se usan condiciones periódicas, dadas las características del potencial que estamos usando,
el sistema no tiene ninguna restricción para expandirse a medida que la simulación avanza. Este es el resultado natural de una simulación en el vacío sobre un sistema de partículas sin enlaces químicos entre ellas.
Esto genera que una mayor cantidad de elementos quede fuera del rango de \textit{cutoff} y, por lo tanto, la cantidad cálculos varíe, disminuyendo a lo largo de la ejecución.

El cambio en la configuración del sistema, a su vez, está afectado por las condiciones iniciales. Las posiciones y velocidades iniciales del sistema pueden hacer que la expansión ocurra más rápidamente. 
Una configuración inicial en condiciones de alta tempratura (distribución de velocidaddes con un mayor valor medio) genera este tipo de efecto. 

Por otro lado, en el caso de usar condiciones periódicas hay otro parámetro que debe ser considerado, es el tamaño de la \textit{caja} de simulación. 
Como se puede ver de lo explicado en \ref{frontera}, si definimos una caja de simulación de lado $L_m=2R_{cut}$ , habrá una y solo una imagen de cada partícula dentro del rango de cutoff.
De esta forma, independientemente de la evolución del sistema, el número de interacciones que deben evaluarse será siempre constante a lo largo de la simulación.

% El tamaño de la caja es, entonces, otro factor importante. De esta forma, a menos que se especifique lo contrario, se define como tamaño de la caja al valor de cutoff/2.

Todos estos factores deben ser tenidos en cuenta a la hora de analizar los resultados, principalmente aquellos que evalúan tiempos de ejecución. 
En las próximas secciones, cuando sea relevante, se especificarán las propiedades del sistema y de la ejecución que se utilizaron en cada prueba.
 
% \begin{itemize}
%  \item El tamaño del sistema, como se   claramente genera una mayor cantidad de calculos a realizar.... 
%  \item Las velocidades y posiciones iniciales ..... . En el apéndice \ref{sistemas} el proceso para asignar velocidades inciales a los sistemas de prueba utilizados.
%  \item el largo de la simulación y el uso de periocidad: es importante tener en cuenta que, si no se usa periodicidad, luego de cierto punto las particulas . 
%  se debe tener en cuenta que a medida que la simulación avanza, las partículas son libres de difundir y éste es el resultado natural de una simulación en el vacío.
%  
% \end{itemize}


% Este efecto se verá en cualquier simulación independientemente de las propiedades del sistema inicial y, claramente es algo a tener en cuenta ya que afecta la correcta evaluación, la aproximación que usamos es aplicar condiciones periódicas de contorno en todas las simulaciones, independientemente del tamaño del sistema.
% Al usar condiciones periodicas 

% , las situaciones mencionadas que afectan a la ejecucion sirven para demostrar propiedades de las implementaciones y como ejecuciones de control, para 


% \section{Performance}
\section{Evaluación de la performance}
% Los sistemas detallados en la sección anterior se utilizaron para evaluar las distintas implementaciones en cuanto a performance..


% PRIMER GRAFICO DEBERÍA IR EL TIEMPO DE EJECUCION DE LAS 3 IMPLEMENTACIONES PARA LOS DISTINTOS SISTEMAS (PERIODICO)
% GRAFICO DE BARRA CON LAS 3 IMPLEMENTACIONES AGRUPADAS EN 3(O 2) SISTEMAS DE PRUEBAS **PERIODICO -  CANTIDAD FIJA DE PASOS*
% *****PUEDO METER LO DE CPU TAMBIEN ACA  ****

La figura \ref{time-compare} muestra la mejora en el tiempo de ejecución obtenida para las distintas implementaciones.
Como puede verse, la implementación que utiliza valores del potencial en una tabla logra una pequeña mejora con respecto a la implementación base, y el uso de alcanza mas del doble de esta mejora en el tiempo.

Estos resultados son los esperados basándose en las consideraciones que planteamos cuando se describieron las implementaciones. 

Se muestra, además, en la figura \ref{time-compare-cpu}, una comparación de las mejoras que se obtienen con respecto a la implementación del cálculo de fuerzas sobre CPU. 
El objetivo es demostrar la escala en la cual se encuentran las distintas implementaciones sobre GPU, con respecto a la implementación utilizando CPU(y sus posibles variantes). 
Esta gran mejora en el tiempo es lo que ha impulsado el uso actual de la arquitectura GPU como estándar en este tipo de aplicaciones.

% Las evaluaciones miden el tiempo de ejecución del paso correspondiente al cálculo de fuerzas.



\begin{figure}[htbp]
\centering
   \includegraphics[width=\plotwidth]{plots/performance/comparacion-tiempos-sistemas.png}
 \caption{Comparaci\'on para los tres casos de prueba estudiados para las distintas implementaciones evaluadas}
 \label{time-compare}
\end{figure}




\begin{figure}[htbp]
\centering
   \includegraphics[width=\plotwidth]{plots/performance/comparacion-tiempos-TODOScpu.png}
 \caption{Comparaci\'on para los tres casos de prueba estudiados y la versión implementada sobre CPU para las distintas implementaciones evaluadas}
 \label{time-compare-cpu}
\end{figure}

\subsection{Efectos de la periodicidad}


% DESPUES EXPLICAR COMO AFECTA LA (NO)PERIODICIAD A LA EJECUCION Y MOSTRA EL GRAFICO DE TIEMPO DE EJECUCION DE LAS 3 IMPLEMENTACIONES PARA LOS DISTINTOS SISTEMAS (***NO** PERIODICO)
% DEBERIA MOSTRAR UN GRAFICO QUE DE ALGUNA FORMA COMPARE LAS IMPLEMENTACIONES PARA 1 SOLA ITERACION Y PARA UN NUMERO X DE ITERACIONES (PERIODICO con max. cutoff Y NO PERIODICO) 
% Y DECIR QUE A MEDIDA QUE SE EJECUTA, LOS ATOMOS SE 'ESCAPAN' DE LA CAJA NO PERIODICA PERO LA EJECUCION PERIODICA SIEMPRE MANTIENE EL NUMERO DE ATOMOS SOBRE LOS CUALES CALCULAR LA FUERZA
En la figura \ref{periodic-effects} se ven los efectos mencionados. Se muestra la ejecución de las diferentes implementaciones para un mismo sistema(X átomos). 
A partir de las distintas ejecuciones se calcularon los tiempos promedios por iteración. 
Se ve que en el caso de tener condiciones no periódicas, al evolucionar la ejecución la expansión del sistema disminuye el número de particulas que se encuentran dentro del radio definido por el cutoff.
Esto genera una disminución en el numero de interacciones que se deben calcular y por lo tanto se reduce el tiempo promedio por iteración. 
En otras condiciones iniciales, o para diferrentes sistemas de interacción, el tiempo promedio podría aumentar.

En el caso de condiciones periódicas(usando el cutoff máximo), todas las partículas del sistema se mantienen dentro del radio de iteracción y por lo tanto el número de 

\begin{figure}[htbp]
\centering
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/NOperiodic/comparacion-NOperiodico.png}
   \caption{Condiciones no periódicas}
   \label{compar-1iter-promedio}
 \end{subfigure}
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/NOperiodic/comparacion-periodico.png}
   \caption{Condiciones periódicas}
   \label{compar-niter-promedio}
 \end{subfigure}
 \caption{Comparaci\'on de tiempos de ejecuci\'on promedio por iteración para condiciones periódicas y no periódicas}
 \label{periodic-effects}
\end{figure}


\subsection{Efectos del cutoff}
Se realiza una evaluación del efecto del cutoff en el tiempo de ejecución
% GRAFICO SCATTER DE LAS 3 IMPLEMENTACIONES vs AUMENTO EN EL CUTOFF 
En la figura \ref{time-vs-cut} se ve el efecto del cutoff sobre el tiempo de ejecución del cálculo de fuerzas de interacción.

% \begin{figure}[htbp]
% \centering
%    \includegraphics[width=\plotwidth]{plots/timeVsCut/timeComparison.png}
%  \caption{Comparaci\'on de las distintas implementaciones sobre un sistema de 8000 átomos}
%  \label{time-vs-cut}
% \end{figure}


% MOSTRAR LO MISMO PARA LOS 3 SISTEMAS  **** TANTO PARA PERIODIC COMO NO PERIODIC****, ASI TAMBIEN SE VE EL EFECTO DEL CUTOFF EN EL TIEMPO PARA LOS CASOS PERIOD Y NO
\begin{figure}[htbp]
\centering
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/timeVsCut/timeComparison-periodic.png}
   \caption{Condiciones de periodicidad}
   \label{compar-1iter}
 \end{subfigure}
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/timeVsCut/timeComparison-NOperiodic.png}
   \caption{Condiciones NO periódicas}
   \label{compar-niter}
 \end{subfigure}
 \caption{Comparaci\'on de tiempos de ejecuci\'on bajo condiciones de periodicidad y NO-periódicas}
 \label{time-vs-cut}
\end{figure}


\subsection{Efectos del tamaño de bloque}

En la figura \ref{blockSize} se ve el efecto de la variación en el tamaño de los bloques para las distintas implementaciones.

En la implementación

Esto se debe a las propiedades que tienen los accesos a memoria global en GPU. Los warps se construyen agrupando threads de un mismo bloque por columnas. 
En nuestro caso, utilizamos como standar bloques de 1024x1 y al tener columnas con 1 solo elemento, los warps se van formando con elementos consecutivos de una fila. es decir, los warps se forman

\begin{figure}[htbp]
\centering
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/blockSize/timeComparison-Analitic.png}
   \caption{Implementación base}
   \label{fig:cpu-scalability-caroteno}
 \end{subfigure}
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/blockSize/timeComparison-Potential.png}
   \caption{implementación Tabla de potencial}
   \label{fig:cpu-scalability-fullereno}
 \end{subfigure}
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/blockSize/timeComparison-Derivative.png}
   \caption{Implementación Tabla de derivadas}
   \label{fig:cpu-scalability-hemo}
 \end{subfigure}
 \caption{Efectos de la variación en los tamaños de bloque para las distintas implementaciones.}
 \label{blockSize}
\end{figure}


\section{Calidad numérica}

\subsection{Tamaños y límites de las tablas}
% GRAFICO DE ERROR ABSOLUTO vs NUMERO TOTAL DE ELEMENTOS DE LA TABLA
En la figura \ref{errorAbsElemTabla} se ven los errores asociados a un número muy chico de elementos en la tabla. 
Se ve como, para el caso de una tabla de potenciales, el error es mayor que la implementacion con tabla de derivadas
para un mismo numero de elementos.

\begin{figure}[htbp]
\centering
   \includegraphics[width=\plotwidth]{plots/erroresTabla/errorAbsolutoElemTabla.png}
 \caption{Comparaci\'on de las distintas implementaciones que utilizan tablas sobre un sistema de 8000 átomos }
 \label{errorAbsElemTabla}
\end{figure}





En la tabla \ref{tabla-errorRelativo-fuerzas} se muestran los errores relativos en el cálculo de fuerzas de las distintas implementaciones.
% EL ERROR ES EL PROMEDIO?? EL MAXIMO???
% QUE TAMAÑO DE TABLA SE USÓ??? 



En la tabla \ref{tabla-errorRelativo-potencial} se muestran los errores relativos en el cálculo de fuerzas de las distintas implementaciones.
% EL ERROR ES EL PROMEDIO?? EL MAXIMO???
% QUE TAMAÑO DE TABLA SE USÓ???  


% **************************************************
% ACA DEBERIA PONER LAS TABLAS CON ERRORES RELATIVOS
% *************************************************



\begin{table}[h]

\begin{minipage}{\linewidth}
\centering
\begin{tabular}{@{}llll@{}}

Error relativo(Fuerza)	 & 200 átomos            	& 8000 átomos        		& 20000 átomos \\ \bottomrule 
% Error relativo(Fuerza)	 &            			&      				& 		 \\ \hline
Implementación 1	 & 1.00E-09 			& 1.00E-09 			& 	-----	 \\ \hline
Implementación 2	 & 0.0003			& 0.0003			& 	-----	\\ \hline
Implementación 3	 & 8.00E-06 			& 8.00E-06			& 		 

\end{tabular}
\caption{Errores relativos en el cálculo de fuerzas para las distintas implementaciones y distintos tamaños de sistemas}
\label{tabla-errorRelativo-fuerzas}
\end{minipage}

\begin{minipage}{\linewidth}
\centering
\begin{tabular}{@{}llll@{}}
\\
\\
% Error relativo(E. Potencial)	 &		           	& 		       		& 		 \\ \bottomrule 
Error relativo(E. Potencial)	 & 200 átomos            	& 8000 átomos        		& 20000 átomos \\ \bottomrule 
Implementación 1	 & 1.00E-09 			& 1.00E-09 			& 		 \\ \hline
Implementación 2	 & 3.00E-05 			& 3.00E-04			&  		\\ \hline
Implementación 3	 & 3.00E-05	 		& 3.00E-04 			& 		 \\ \bottomrule

\end{tabular}
\end{minipage}
\caption{Errores relativos en el cálculo de fuerzas para las distintas implementaciones y distintos tamaños de sistemas}
\label{tabla-errorRelativo-potencial}
\end{table}


% 
% \begin{minipage}{\linewidth}
% \centering
% \begin{tabular}{@{}llll@{}}
% \toprule
% % Error relativo		 & 200 átomos            	& 8000 átomos        		& 20000 átomos \\ \midrule
% Implementación 1	 & 1.00E-09 			& 1.00E-09 			& 		 \\ \hline
% Implementación 2	 & 3.00E-05 			& 3.00E-04			&  		\\ \hline
% Implementación 3	 & 3.00E-05	 		& 3.00E-04 			& 		 \\ \bottomrule
% \end{tabular}
% \end{minipage}


% 
% 
% 
% \begin{table}[h]
% \centering
% \begin{tabular}{@{}llll@{}}
% \toprule
% Error relativo		 & 200 átomos            	& 8000 átomos        		& 20000 átomos \\ \midrule
% Implementación 1	 & 1.00E-09 			& 1.00E-09 			& 		 \\ \hline
% Implementación 2	 & 3.00E-05 			& 3.00E-04			&  		\\ \hline
% Implementación 3	 & 3.00E-05	 		& 3.00E-04 			& 		 \\ \bottomrule
% \end{tabular}
% \caption{Errores relativos en el cálculo de la energía potencial total para las distintas implementaciones y distintos tamaños de sistemas}
% \label{tabla-errorRelativo-energia}
% \end{table}
% 


\subsubsection{Efectos del limite superior de la tabla}

En la figura \ref{time-vs-cut-error-superior} se ven los errores al aumentar el valor absoluto en el indice superior de la tabla, manteniendo fijo el número total de elementos de la tabla 
\begin{figure}[htbp]
\centering
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/erroresTabla/errorAbsolutoLimite200.png}
   \caption{Condiciones de periodicidad}
   \label{compar-1iter}
 \end{subfigure}
\begin{subfigure}[b]{\plotwidthtres}
   \includegraphics[width=\textwidth]{plots/erroresTabla/errorAbsolutoLimite8k.png}
   \caption{Condiciones NO periódicas}
   \label{compar-niter}
 \end{subfigure}
 \caption{Comparacion de efectos en el error del calculo de fuerzas para sistemas de distinto tamaño}
 \label{time-vs-cut-error-superior}
\end{figure}





\subsection{Estabilidad de la simulación}
% GRAFICO
% Acá debería mostrar como la energia se mantiene constante cuando hago una simulacion larga (distintos valores de tamano de tabla	)


